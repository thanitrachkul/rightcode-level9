<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RightCode Game Level 9: Dog's Bone Maze</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kanit:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Kanit ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏•‡∏∞ Inter ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© */
        body {
            font-family: 'Kanit', 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏≤‡∏Å */
        .dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            cursor: grabbing;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡∏≤‡∏á (Editor / Bank) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏ó‡∏±‡∏ö */
        .drag-over {
            border-style: dashed;
            border-color: #3b82f6; /* blue-500 */
            background-color: #eff6ff; /* blue-50 */
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ */
        .drag-item {
            touch-action: none; /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            position: relative; 
            border: 4px solid transparent; 
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Game Grid) */
        .grid-slot {
            width: 100%;
            height: 100px;
            background-color: #ffffff;
            border: 2px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem; /* text-5xl */
            transition: background-color 0.2s;
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏≠‡∏¢‡∏π‡πà */
        .dog-position {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
        }
        
        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á */
        .obstacle-slot {
            background-color: #e2e8f0; /* gray-200 */
            border-color: #94a3b8; /* gray-400 */
            cursor: not-allowed;
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (Executing) */
        .executing {
            border-color: #22c55e; /* green-500 */
            transform: scale(1.05);
        }

        /* ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Modal Animation (Fade in & Zoom) */
        #success-modal {
            transition: opacity 0.3s ease-out;
        }
        #success-modal #modal-content {
            transition: all 0.3s ease-out 0.1s;
        }
        
        #success-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #success-modal.hidden #modal-content {
            opacity: 0;
            transform: scale(0.9);
        }
        
        #success-modal:not(.hidden) {
            opacity: 1;
        }
        #success-modal:not(.hidden) #modal-content {
            opacity: 1;
            transform: scale(1);
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <main class="w-full max-w-4xl bg-white rounded-2xl shadow-2xl p-6 md:p-10">
        
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-yellow-600">RightCode Game Level 9</h1>
            <p class="text-lg md:text-xl text-gray-700 mt-2">‡∏û‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÑ‡∏õ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å!</p>
            <p class="text-base text-gray-500 mt-4 max-w-3xl mx-auto">
                ‡∏•‡∏≤‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å ‚û°Ô∏è, ‚¨áÔ∏è, ‚¨ÖÔ∏è ‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô "‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç üê∂ (‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢) 
                ‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏ñ‡∏∂‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å ü¶¥ (‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤) ‡πÇ‡∏î‡∏¢ <span class="font-bold text-red-500">‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ üå≥!</span>
            </p>
        </div>
        
        <!-- Game Layout -->
        <div class="flex flex-col md:flex-row gap-6">
            
            <!-- Left Side: Grid + Bank -->
            <div class="flex-1">
                <!-- 1. Game Grid -->
                <div id="game-grid-container" class="mb-6 p-4 bg-gray-200 rounded-xl border border-gray-300">
                    <h3 class="text-center font-semibold text-gray-700 mb-3 text-lg">
                        ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
                    </h3>
                    <div id="game-grid" class="grid grid-cols-3 gap-2 max-w-sm mx-auto">
                        <!-- ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                    </div>
                </div>

                <!-- 3. Block Bank -->
                <div id="block-bank-container" class="p-4 bg-yellow-50 rounded-xl border-2 border-yellow-200 min-h-[120px]">
                    <h3 class="text-center font-semibold text-yellow-800 mb-3 text-lg">
                        ‡∏Ñ‡∏•‡∏±‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å (‡∏•‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
                    </h3>
                    <div id="block-bank-drag-items" class="drop-zone-area flex flex-wrap justify-center items-start gap-2 min-h-[80px] p-2 rounded-lg bg-white">
                        <!-- ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢ JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Right Side: Code Editor -->
            <div class="w-full md:w-1/2">
                <!-- 2. Code Editor -->
                <div id="code-editor-container" class="mb-6 p-4 bg-blue-50 rounded-xl border-2 border-blue-200 min-h-[400px] h-full">
                    <h3 class="text-center font-semibold text-blue-800 mb-3 text-lg">
                        ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á (‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà)
                        <!-- (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 4 -->
                        <span class="text-sm font-normal text-gray-600 ml-2">(<span id="block-count">0</span> / 4)</span>
                    </h3>
                    <div id="code-editor-dropzone" class="drop-zone-area flex flex-wrap justify-start items-start gap-2 min-h-[300px] p-2 rounded-lg bg-white">
                        <!-- ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡∏°‡∏≤‡∏à‡∏∞‡∏°‡∏≤‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                    </div>
                </div>
                
            </div>
        </div>

        <!-- Controls -->
        <div class="mt-8 text-center">
            <div class="flex justify-center gap-4">
                <button id="check-btn" class="px-8 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Run)
                </button>
                <button id="reset-btn" class="px-8 py-3 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
            <div id="message" class="mt-6 text-2xl font-bold h-8">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
            </div>
        </div>

    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <!-- Backdrop -->
        <div class="absolute inset-0" id="modal-backdrop"></div>
        
        <div id="modal-content" class="relative bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
            <span class="text-8xl mb-6 block" role="img" aria-label="Party Popper">ü•≥</span>
            <h2 class="text-3xl font-bold text-gray-900 mb-2">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢!</h2>
            <p class="text-lg text-gray-700 mb-8">‡∏Ñ‡∏∏‡∏ì‡∏û‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÑ‡∏õ‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</p>
            <button id="play-again-btn" class="w-full px-8 py-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 text-lg">
                ‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà (Level 9)
            </button>
        </div>
    </div>
    
    <!-- (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡∏ã‡πà‡∏≠‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡πà‡∏≤‡∏á‡πÜ -->
    <span id="dog" class="text-5xl hidden" role="img" aria-label="Dog">üê∂</span>
    <span id="bone" class="text-5xl hidden" role="img" aria-label="Bone">ü¶¥</span>
    <span id="tree" class="text-5xl hidden" role="img" aria-label="Tree">üå≥</span>

<script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö UI ---
            const gameGrid = document.getElementById('game-grid');
            const codeEditor = document.getElementById('code-editor-dropzone');
            const blockBank = document.getElementById('block-bank-drag-items');
            
            const checkBtn = document.getElementById('check-btn');
            const resetBtn = document.getElementById('reset-btn');
            const messageEl = document.getElementById('message');
            
            const modal = document.getElementById('success-modal');
            const modalBackdrop = document.getElementById('modal-backdrop');
            const playAgainBtn = document.getElementById('play-again-btn');
            const blockCountEl = document.getElementById('block-count');

            // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡∏î‡∏∂‡∏á‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö‡∏°‡∏≤‡∏à‡∏≤‡∏Å HTML ‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ
            const dogElPrototype = document.getElementById('dog');
            const boneElPrototype = document.getElementById('bone');
            const treeElPrototype = document.getElementById('tree');

            // --- ‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡∏° (Grid 3x3) ---
            const TOTAL_SLOTS = 9;
            const GRID_COLS = 3;
            const START_POS_INDEX = 0; // ‡∏°‡∏∏‡∏°‡∏ö‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ (index 0)
            const END_POS_INDEX = 8;   // ‡∏°‡∏∏‡∏°‡∏•‡πà‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤ (index 8)
            const OBSTACLE_INDICES = [1, 5]; // ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ (index 1 = [0,1], index 5 = [1,2])
            // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô 4
            const CORRECT_MOVES = 4;   // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î

            let draggedItem = null; 
            let dogPosIndex = START_POS_INDEX;
            let dogEl, boneEl; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö Element ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á

            // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏ö‡∏•‡πá‡∏≠‡∏Å ---
            function updateBlockCount() {
                const count = codeEditor.querySelectorAll('.drag-item').length;
                blockCountEl.textContent = count;
            }

            // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏° ---
            function initGame() {
                modal.classList.add('hidden');
                messageEl.textContent = '';
                messageEl.className = 'mt-6 text-2xl font-bold h-8';
                
                checkBtn.disabled = false;
                resetBtn.disabled = false;
                
                // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡πÇ‡∏Ñ‡∏•‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡πÅ‡∏ö‡∏ö
                dogEl = dogElPrototype.cloneNode(true);
                boneEl = boneElPrototype.cloneNode(true);
                dogEl.id = 'active-dog';
                boneEl.id = 'active-bone';
                dogEl.classList.remove('hidden');
                boneEl.classList.remove('hidden');

                // 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á Game Grid (3x3)
                gameGrid.innerHTML = '';
                for (let i = 0; i < TOTAL_SLOTS; i++) {
                    const slot = document.createElement('div');
                    slot.className = 'grid-slot';
                    slot.dataset.index = i;
                    gameGrid.appendChild(slot);
                    
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á
                    if (OBSTACLE_INDICES.includes(i)) {
                        slot.classList.add('obstacle-slot');
                        const treeClone = treeElPrototype.cloneNode(true);
                        treeClone.id = `tree-${i}`; // ‡πÉ‡∏´‡πâ‡∏°‡∏µ id ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
                        treeClone.classList.remove('hidden'); // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ
                        slot.appendChild(treeClone);
                    }
                }
                
                // 2. ‡∏ß‡∏≤‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å
                dogPosIndex = START_POS_INDEX;
                updateDogPositionUI(START_POS_INDEX, null); // ‡∏ß‡∏≤‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                gameGrid.children[END_POS_INDEX].appendChild(boneEl);

                // 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á
                blockBank.innerHTML = '';
                codeEditor.innerHTML = '';
                updateBlockCount(); 
                
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 ‡∏ö‡∏•‡πá‡∏≠‡∏Å "‡πÄ‡∏î‡∏¥‡∏ô‡∏Ç‡∏ß‡∏≤"
                for (let i = 0; i < 4; i++) {
                    createBlock('move-right', '‚û°Ô∏è', `block-right-${i}`);
                }
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 ‡∏ö‡∏•‡πá‡∏≠‡∏Å "‡πÄ‡∏î‡∏¥‡∏ô‡∏•‡∏á"
                for (let i = 0; i < 4; i++) {
                    createBlock('move-down', '‚¨áÔ∏è', `block-down-${i}`);
                }
                // ‡∏™‡∏£‡πâ‡∏≤‡∏á 4 ‡∏ö‡∏•‡πá‡∏≠‡∏Å "‡πÄ‡∏î‡∏¥‡∏ô‡∏ã‡πâ‡∏≤‡∏¢"
                for (let i = 0; i < 4; i++) {
                    createBlock('move-left', '‚¨ÖÔ∏è', `block-left-${i}`);
                }
            }
            
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å
            function createBlock(type, emoji, id) {
                const element = document.createElement('div');
                element.id = id;
                element.className = 'drag-item w-20 h-16 bg-blue-500 text-white shadow-md rounded-lg flex items-center justify-center cursor-move transition-all duration-150 p-2 border-4 border-transparent hover:shadow-lg';
                element.draggable = true;
                element.dataset.type = type; 
                
                element.innerHTML = `<span class="text-3xl" role="img">${emoji}</span>`;

                addDragItemListeners(element);
                blockBank.appendChild(element);
            }
            
            // --- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏ö‡∏ô UI ---
            function updateDogPositionUI(newIndex, oldIndex) {
                const slots = gameGrid.children;
                
                // ‡∏•‡∏ö‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if (oldIndex !== null && slots[oldIndex]) {
                    slots[oldIndex].classList.remove('dog-position');
                }
                
                // ‡∏¢‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏ô‡∏±‡∏Ç (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á)
                if (slots[newIndex]) {
                    slots[newIndex].appendChild(dogEl);
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÉ‡∏´‡∏°‡πà
                    slots[newIndex].classList.add('dog-position');
                }
                
                dogPosIndex = newIndex;
            }

            // --- Event Listeners (Drag & Drop) ---
            
            function addDragItemListeners(item) {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Listeners ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö Drop Zones
            [codeEditor, blockBank].forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
                zone.addEventListener('drop', handleDrop);
            });

            // --- Handlers: ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (Mouse) ---
            
            function handleDragStart(e) {
                draggedItem = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', this.id);
                setTimeout(() => this.style.visibility = 'hidden', 0);
            }

            function handleDragEnd() {
                this.classList.remove('dragging');
                this.style.visibility = 'visible';
                draggedItem = null;
                document.querySelectorAll('.drag-over').forEach(zone => zone.classList.remove('drag-over'));
            }

            function handleDragOver(e) {
                e.preventDefault(); 
                e.dataTransfer.dropEffect = 'move';
            }

            function handleDragEnter(e) {
                e.preventDefault();
                const dropTarget = e.target.closest('.drop-zone-area');
                if (dropTarget) dropTarget.classList.add('drag-over');
            }

            function handleDragLeave(e) {
                const dropTarget = e.target.closest('.drop-zone-area');
                if (dropTarget) dropTarget.classList.remove('drag-over');
            }

            function handleDrop(e) {
                e.preventDefault();
                e.stopPropagation(); 
                
                const dropTarget = e.target.closest('.drop-zone-area');
                if (!dropTarget || !draggedItem) return;

                dropTarget.classList.remove('drag-over');
                dropTarget.appendChild(draggedItem);
                updateBlockCount(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
            }

            // --- Handlers: ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (Touch) ---
            let currentDropTarget = null, clone = null;

            function handleTouchStart(e) {
                e.preventDefault();
                draggedItem = this;
                draggedItem.classList.add('dragging');
                const touch = e.touches[0];

                clone = draggedItem.cloneNode(true);
                clone.style.position = 'absolute';
                clone.style.pointerEvents = 'none';
                clone.style.zIndex = '1000';
                clone.style.opacity = '0.8';
                document.body.appendChild(clone);
                
                draggedItem.style.visibility = 'hidden';
                moveClone(touch.pageX, touch.pageY);
            }
            
            function moveClone(x, y) {
                if (!clone) return;
                clone.style.left = `${x - clone.offsetWidth / 2}px`;
                clone.style.top = `${y - clone.offsetHeight / 2}px`;
            }

            function handleTouchMove(e) {
                e.preventDefault();
                if (!draggedItem) return;
                const touch = e.touches[0];
                moveClone(touch.pageX, touch.pageY);

                clone.style.display = 'none'; 
                let elementUnder = document.elementFromPoint(touch.clientX, touch.clientY);
                clone.style.display = 'flex'; 

                const dropTarget = elementUnder ? elementUnder.closest('.drop-zone-area') : null;

                if (currentDropTarget && currentDropTarget !== dropTarget) {
                    currentDropTarget.classList.remove('drag-over');
                }
                
                if (dropTarget) {
                    dropTarget.classList.add('drag-over');
                    currentDropTarget = dropTarget;
                } else {
                    currentDropTarget = null;
                }
            }

            function handleTouchEnd(e) {
                e.preventDefault();
                if (!draggedItem) return;

                if (clone) clone.remove();
                clone = null;
                draggedItem.style.visibility = 'visible';
                draggedItem.classList.remove('dragging');

                if (currentDropTarget) {
                    currentDropTarget.classList.remove('drag-over');
                    handleDrop({ 
                        target: currentDropTarget, 
                        preventDefault: () => {}, 
                        stopPropagation: () => {} 
                    });
                } else {
                    const originalParent = draggedItem.parentElement;
                    if(originalParent) originalParent.appendChild(draggedItem);
                    updateBlockCount(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö
                }
                draggedItem = null;
                currentDropTarget = null;
            }

            // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (Run Program) ---
            
            async function runProgram() {
                checkBtn.disabled = true;
                resetBtn.disabled = true;
                messageEl.textContent = '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏î‡∏¥‡∏ô...';
                messageEl.className = 'mt-6 text-2xl font-bold h-8 text-gray-700';

                // 1. ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç
                let currentPosIndex = START_POS_INDEX;
                updateDogPositionUI(START_POS_INDEX, dogPosIndex); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á UI

                // 2. ‡∏î‡∏∂‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                const blocks = codeEditor.querySelectorAll('.drag-item');
                const moveCount = blocks.length;
                let hitObstacle = false;
                let hitWall = false;
                
                await new Promise(resolve => setTimeout(resolve, 500)); // ‡∏£‡∏≠‡πÅ‡∏õ‡πä‡∏ö

                // 3. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ó‡∏≥‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                for (let i = 0; i < moveCount; i++) {
                    const block = blocks[i];
                    block.classList.add('executing');
                    await new Promise(resolve => setTimeout(resolve, 300)); 
                    
                    let oldPosIndex = currentPosIndex;
                    let nextPosIndex = currentPosIndex;
                    const blockType = block.dataset.type;

                    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà
                    if (blockType === 'move-right') {
                        if ((currentPosIndex + 1) % GRID_COLS === 0) { hitWall = true; } else { nextPosIndex++; }
                    } else if (blockType === 'move-down') {
                        if (currentPosIndex + GRID_COLS >= TOTAL_SLOTS) { hitWall = true; } else { nextPosIndex += GRID_COLS; }
                    } else if (blockType === 'move-left') {
                        if (currentPosIndex % GRID_COLS === 0) { hitWall = true; } else { nextPosIndex--; }
                    }
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á
                    if (hitWall) {
                        messageEl.textContent = '‡πÇ‡∏≠‡πä‡∏∞! ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÄ‡∏î‡∏¥‡∏ô‡∏ä‡∏ô‡∏Å‡∏≥‡πÅ‡∏û‡∏á! üòµ';
                        messageEl.className = 'mt-6 text-2xl font-bold h-8 text-red-600';
                        block.classList.remove('executing');
                        break; 
                    }

                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á
                    if (OBSTACLE_INDICES.includes(nextPosIndex)) {
                        hitObstacle = true;
                        messageEl.textContent = '‡πÇ‡∏≠‡πä‡∏∞! ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÄ‡∏î‡∏¥‡∏ô‡∏ä‡∏ô‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ! üå≥';
                        messageEl.className = 'mt-6 text-2xl font-bold h-8 text-red-600';
                        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÅ‡∏ï‡πà‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                        block.classList.remove('executing');
                        break;
                    }

                    currentPosIndex = nextPosIndex;
                    updateDogPositionUI(currentPosIndex, oldPosIndex);
                    await new Promise(resolve => setTimeout(resolve, 300)); 
                    block.classList.remove('executing');
                }
                
                if (hitWall || hitObstacle) {
                    resetBtn.disabled = false;
                    checkBtn.disabled = false;
                    return; 
                }
                
                await new Promise(resolve => setTimeout(resolve, 500)); 

                // 4. (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                if (currentPosIndex === END_POS_INDEX) {
                    // ‡∏Ç‡∏≠‡πÅ‡∏Ñ‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ ‡∏Å‡πá‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                    messageEl.textContent = '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ü•≥';
                    messageEl.className = 'mt-6 text-2xl font-bold h-8 text-green-600';
                    modal.classList.remove('hidden');
                    checkBtn.disabled = true;
                } else {
                    messageEl.textContent = '‡πÇ‡∏≠‡πä‡∏∞! ‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÑ‡∏õ‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏π‡∏Å üò¢';
                    messageEl.className = 'mt-6 text-2xl font-bold h-8 text-red-600';
                }

                resetBtn.disabled = false;
                // (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á) ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢) ‡∏Å‡πá‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
                if(currentPosIndex !== END_POS_INDEX) {
                    checkBtn.disabled = false; 
                }
            }

            // --- ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏õ‡∏∏‡πà‡∏° ---
            checkBtn.addEventListener('click', runProgram);
            resetBtn.addEventListener('click', initGame);
            playAgainBtn.addEventListener('click', initGame);
            modalBackdrop.addEventListener('click', () => modal.classList.add('hidden'));

            // --- ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å ---
            initGame();
        });
    </script>

</body>
</html>
